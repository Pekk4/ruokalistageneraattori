<!DOCTYPE html>
<html lang="fi-Fi">
    <head>
        <title>Tervetuloa</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="static/css/style.css" rel="stylesheet">
        <link href="static/css/main.css" rel="stylesheet">
        <script>
            let userMeals;
            let saveMealSuccess;
            const daysOfWeek = {
                0: "Maanantai",
                1: "Tiistai",
                2: "Keskiviikko",
                3: "Torstai",
                4: "Perjantai",
                5: "Lauantai",
                6: "Sunnuntai",
            };

            function fetchMeals() {
                const xhttp = new XMLHttpRequest();
                const selectElem = document.getElementById("meal-form-select");
                const selectWrapper = document.getElementById("meal-form-select-wrapper");

                if (selectElem.childElementCount < 1) {
                    xhttp.onreadystatechange = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            userMeals = new Map(Object.entries(JSON.parse(this.response)));

                            buildMealList(selectElem);
                            selectElem.classList.remove("hidden");

                            selectWrapper.innerHTML = null;
                            selectWrapper.appendChild(selectElem);
                        } else {
                            insertSpinner(selectWrapper);
                        }
                    }
                    xhttp.open("GET", "/get_meals");
                    xhttp.send();
                }
            }

            function replaceMeal(form, day) {
                const formData = new FormData(form);
                const mealData = formData.get("mealdata").split(":");

                askToReplaceMeal(day, mealData);
            }

            function askToReplaceMeal(day, mealData) {
                const confirmStr = "Vaihdetaanko " +daysOfWeek[day].toLowerCase()+ "n ruokalajiksi " +mealData[1].toLowerCase()+ "?";
                const answerValue = confirm(confirmStr);

                if (answerValue === true) {
                    saveMeal(day, mealData);
                }
            }

            function saveMeal(day, mealData) {
                const xhttp = new XMLHttpRequest();
                const formData = new FormData();

                formData.append(day, mealData[0]);
                formData.append("csrf_token", document.getElementById("csrf_token").value);

                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        document.getElementById("meal-name-"+day).innerHTML = mealData[1];
                        closeEditMeal();
                    } else {
                        insertSpinner(document.getElementById("meal-to-edit"));
                    }
                }
                xhttp.open("POST", "/replace_meal");
                xhttp.send(formData);
            }

            function insertSpinner(element) {
                element.innerHTML = "<img src='static/images/spinner.gif' width='70' height='70'>";
            }

            function generateMeal(day) {
                const xhttp = new XMLHttpRequest();
                
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        const meal = JSON.parse(this.response);

                        askToReplaceMeal(day, [meal.id, meal.meal]);
                    } else {
                        insertSpinner(document.getElementById("meal-to-edit"));
                    }
                }
                xhttp.open("GET", "/generate_meal");
                xhttp.send();
            }

            function buildMealList(parentElement) {
                if (parentElement.childElementCount < 1) {
                    for (const [key, value] of userMeals) {
                        const optionElement = document.createElement("option");

                        optionElement.value = key+":"+value;
                        optionElement.text = value;

                        parentElement.appendChild(optionElement);
                    }
                }
            }

            function editMeal(day) {
                const mealForm = document.getElementById("replace-meal-form");
                const currentMeal = document.getElementById("meal-name-"+day);

                document.getElementById("day-of-meal").innerHTML = daysOfWeek[day];
                document.getElementById("meal-to-edit").innerHTML = currentMeal.innerHTML;

                fetchMeals();

                document.getElementById("current-menu-content").classList.add("hidden");
                document.getElementById("buttons").classList.add("hidden");
                document.getElementById("form-div").classList.remove("hidden");

                document.getElementById("replace-button").onclick = () => {
                    replaceMeal(mealForm, day);
                };
                document.getElementById("generate-meal-button").onclick = () => {
                    generateMeal(day);
                };
            }

            function editMenu() {
                const editMenuButton = document.getElementById("start-editing-button");

                for (const div of document.getElementsByClassName("single-meal")) {
                    div.classList.remove("border-b", "rounded-bl", "rounded-br", "hover:bg-white");
                }

                document.getElementById("edit-menu-buttons").classList.replace("hidden", "grid");
                document.getElementById("meals-of-week").classList.remove("rounded-b", "border-b");
                document.getElementById("former-menus-wrapper").classList.add("hidden");

                editMenuButton.innerHTML = "Lopeta muokkaus";
                editMenuButton.onclick = () => { closeEditMenu(); };
            }

            function closeEditMeal() {
                document.getElementById("current-menu-content").classList.remove("hidden");
                document.getElementById("buttons").classList.remove("hidden");
                document.getElementById("form-div").classList.add("hidden");
            }

            function closeEditMenu() {
                const editMenuButton = document.getElementById("start-editing-button");
                let i = 0;

                for (const div of document.getElementsByClassName("single-meal")) {
                    i == 0 || i == 6 ? div.classList.add("rounded-bl", "rounded-br") : null;

                    div.classList.add("hover:bg-white");
                    i++;
                }

                document.getElementById("edit-menu-buttons").classList.replace("grid", "hidden");
                document.getElementById("meals-of-week").classList.add("border-b", "rounded-b");
                document.getElementById("former-menus-wrapper").classList.remove("hidden");

                editMenuButton.innerHTML = "Muokkaa ruokalistaa";
                editMenuButton.onclick = () => { editMenu(); };
            }

            function toggleFormerMenus(isOpen = false) {
                if (isOpen === false) {
                    document.getElementById("former-menus").classList.add("hidden");
                    document.getElementById("former-menus-button").classList.remove("hidden");
                } else {
                    document.getElementById("former-menus").classList.remove("hidden");
                    document.getElementById("former-menus-button").classList.add("hidden");
                }
            }
        </script>
    </head>
    {% include "header.html" %}{% if session.username %}
        
        <div id="main-content" class="bg-orange-100/90 m-14 border border-black rounded grid place-items-center">
            <div id="header" class="p-12">
                <p class="text-center text-2xl font-bold">Viikon {{ today.isocalendar()[1] }} ruokalista:</p>
            </div>


            <div id="form-div" class="hidden relative text-center border border-black px-20 py-4 mb-20 bg-orange-100 rounded">
                <div onclick="closeEditMeal()" class="absolute top-1 right-1 hover:cursor-pointer"><img src="static/images/cancel.png"></div>
                <div class="border border-black rounded p-1 mb-2 grid place-content-center">
                    <p id="day-of-meal" class="m-1 font-semibold">Maanantai</p>
                    <p id="meal-to-edit" class="m-1">Hapansilakkavoileivät</p>
                </div>
                <p class="m-1 font-semibold">Valitse ruokalaji:</p>
                <form id="replace-meal-form">
                    <div id="meal-form-select-wrapper" class="grid place-content-center">
                        <select id="meal-form-select" name="mealdata" class="my-3 hidden"></select>
                    </div>
                    <div class="m-1">
                        <button id="replace-button" class="bg-green-600 hover:bg-green-700 text-white font-bold border px-2 py-1 border-green-800 rounded" type="button" onclick="null">
                            Vaihda ruokalajiksi
                        </button>
                    </div>
                    <input id="csrf_token" type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                </form>
                <p class="m-1 font-semibold">tai</p>
                <button id="generate-meal-button" class="m-1 bg-green-600 hover:bg-green-700 text-white font-bold px-2 py-1 border border-green-800 rounded">
                    Generoi uusi ruokalaji
                </button>
            </div>


            <div id="current-menu-content">
                <div id="meals-of-week" class="grid grid-cols-7 text-center border-b rounded-b border-t border-l border-black rounded-t">{% for day, meal in menumeals %}
                    <div id="single-meal-div-{{ day }}" class="single-meal w-[180px] break-words p-3 border-r border-black {% if day == 0 %}rounded-tl rounded-bl{% elif day == 6 %}rounded-tr rounded-br{% endif %} {% if today.isocalendar()[2]-1 == day %}bg-orange-400{% else %}bg-orange-100{% endif %} hover:bg-white">
                        <p class="p-1 font-semibold">{{ days[day] }}:</p>
                        <p id="meal-name-{{ day }}" class="p-1">{{ meal }}</p>
                    </div>{% endfor %}
                </div>
                <div id="edit-menu-buttons" class="hidden border-b border-l border-black grid-cols-7 rounded-b">{% for day in day_numbers %}
                    <div id="form-div-{{ day }}" class="form-div border-r border-black text-center {% if today.isocalendar()[2]-1 == day %}bg-orange-400{% else %}bg-orange-100{% endif %} {% if day == 0 %}rounded-bl{% elif day == 6 %}rounded-br{% endif %} ">
                        <button class="bg-green-600 hover:bg-green-700 text-white font-bold my-5 py-2 px-4 border border-green-800 rounded" onclick="editMeal({{ day }})">Vaihda</button>
                    </div>{% endfor %}
                </div>
            </div>

            
            <div id="buttons" class="flex flex-row items-center m-12">

                <button id="start-editing-button" onclick="editMenu()" class="m-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 border border-green-800 rounded">
                    Muokkaa ruokalistaa
                </button>

                <button onclick="location.replace('/generate')" class="m-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 border border-green-800 rounded">
                    Generoi uusi ruokalista
                </button>

                <button onclick="null" class="m-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 border border-green-800 rounded">
                    Kerää ostoslista
                </button>

            </div>{% if menus %}
            <div id="former-menus-wrapper">
                <div id="former-menus-button" class="mb-14"><button onclick="toggleFormerMenus(true)" class="m-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 border border-green-800 rounded">Näytä aiemmat ruokalistat</button></div>
                <div id="former-menus" class="hidden relative border border-black bg-orange-100 mb-14 p-5 rounded">
                    <div onclick="toggleFormerMenus()" class="absolute top-1 right-1 hover:cursor-pointer"><img src="static/images/cancel.png"></div>
                    <p class="px-5 py-3 font-semibold">Aiemmat ruokalistat:</p>{% for menu in menus %}{% set timestamp = menu.timestamp.isocalendar() %}
                    <p class="px-5 hover:font-semibold"><a href="/old_menus?week={{ timestamp[1] }}&year={{ timestamp[0] }}">Viikko {{ timestamp[1] }} / {{ timestamp[0] }}</a></p>{% endfor %}
                    <p class="px-5 pt-2 pb-3 hover:font-semibold"><a href="/old_menus">Näytä lisää...</a></p>
                </div>
            </div>{% endif %}
      {% else %}
      <a href="/login_page">Kirjaudu sisään</a>
      <p>tai</p>
      <a href="/register_page">Rekisteröidy</a>
      {% endif %}
    </body>
</html>